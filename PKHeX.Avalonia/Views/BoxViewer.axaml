<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:PKHeX.Avalonia.ViewModels"
             xmlns:models="using:PKHeX.Avalonia.Models"
             x:Class="PKHeX.Avalonia.Views.BoxViewer"
             x:DataType="vm:BoxViewerViewModel"
             Focusable="True">

    <!-- Keyboard Navigation -->
    <UserControl.KeyBindings>
        <KeyBinding Gesture="Left" Command="{Binding MoveSelectionCommand}" CommandParameter="Left" />
        <KeyBinding Gesture="Right" Command="{Binding MoveSelectionCommand}" CommandParameter="Right" />
        <KeyBinding Gesture="Up" Command="{Binding MoveSelectionCommand}" CommandParameter="Up" />
        <KeyBinding Gesture="Down" Command="{Binding MoveSelectionCommand}" CommandParameter="Down" />
        <KeyBinding Gesture="Enter" Command="{Binding ActivateSlotCommand}" />
        <KeyBinding Gesture="Space" Command="{Binding ActivateSlotCommand}" />
        <KeyBinding Gesture="Home" Command="{Binding SelectFirstSlotCommand}" />
        <KeyBinding Gesture="End" Command="{Binding SelectLastSlotCommand}" />
        <KeyBinding Gesture="PageUp" Command="{Binding PreviousBoxCommand}" />
        <KeyBinding Gesture="PageDown" Command="{Binding NextBoxCommand}" />
    </UserControl.KeyBindings>

    <Border Padding="20" Background="{DynamicResource ThemeBackgroundBaseBrush}">
        <StackPanel Spacing="16" HorizontalAlignment="Center">
            
            <!-- Box Navigation - Integrated Header -->
            <Border Classes="card" Padding="0" Width="410" HorizontalAlignment="Center">
                <Grid ColumnDefinitions="40,*,40" Height="40">
                    <Button Grid.Column="0"
                            Content="◀"
                            Command="{Binding PreviousBoxCommand}"
                            ToolTip.Tip="Previous Box (PageUp)"
                            Background="Transparent"
                            BorderThickness="0"
                            HorizontalAlignment="Stretch"
                            VerticalAlignment="Stretch"
                            HorizontalContentAlignment="Center"
                            VerticalContentAlignment="Center"
                            FontSize="14" />
                    
                    <TextBlock Grid.Column="1" 
                               Text="{Binding BoxName}"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               FontWeight="SemiBold"
                               FontSize="16"
                               Foreground="{DynamicResource ThemeTextPrimaryBrush}" />

                    <Button Grid.Column="2"
                            Content="▶"
                            Command="{Binding NextBoxCommand}"
                            ToolTip.Tip="Next Box (PageDown)"
                            Background="Transparent"
                            BorderThickness="0"
                            HorizontalAlignment="Stretch"
                            VerticalAlignment="Stretch"
                            HorizontalContentAlignment="Center"
                            VerticalContentAlignment="Center"
                            FontSize="14" />
                </Grid>
            </Border>

            <!-- Box Grid (6 columns x 5 rows = 30 slots) -->
            <Border Classes="card-elevated" Padding="1" Width="410" Height="282" HorizontalAlignment="Center">
                <ItemsControl ItemsSource="{Binding Slots}" x:Name="SlotGrid">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <UniformGrid Columns="6" Rows="5" Width="408" Height="280" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="models:SlotData">
                            <Button Classes="slot"
                                    Classes.selected="{Binding IsSelected}"
                                    Margin="0"
                                    PointerPressed="OnSlotPointerPressed"
                                    PointerMoved="OnSlotPointerMoved"
                                    DragDrop.AllowDrop="True"
                                    DragDrop.Drop="OnSlotDrop"
                                    ToolTip.Tip="{Binding ToolTipSummary}"
                                    Click="OnSlotClicked"
                                    DoubleTapped="OnSlotDoubleTapped"
                                    Tag="{Binding}">
                                <Button.ContextMenu>
                                    <ContextMenu>
                                        <MenuItem Header="View (Ctrl+Click)"
                                                  Command="{Binding $parent[UserControl].((vm:BoxViewerViewModel)DataContext).ViewSlotCommand}"
                                                  CommandParameter="{Binding}"
                                                  IsEnabled="{Binding !IsEmpty}" />
                                        <MenuItem Header="Set (Shift+Click)"
                                                  Command="{Binding $parent[UserControl].((vm:BoxViewerViewModel)DataContext).SetSlotCommand}"
                                                  CommandParameter="{Binding}" />
                                        <Separator />
                                        <MenuItem Header="Delete (Alt+Click)"
                                                  Command="{Binding $parent[UserControl].((vm:BoxViewerViewModel)DataContext).DeleteSlotCommand}"
                                                  CommandParameter="{Binding}"
                                                  IsEnabled="{Binding !IsEmpty}" />
                                    </ContextMenu>
                                </Button.ContextMenu>
                                <Panel Width="72" Height="60">
                                    <!-- Empty slot indicator -->
                                    <Border Classes="empty-slot"
                                            IsVisible="{Binding IsEmpty}" />

                                    <!-- Pokemon Sprite -->
                                    <Image Source="{Binding Sprite}"
                                           Width="68" Height="56"
                                           RenderOptions.BitmapInterpolationMode="HighQuality"
                                           IsVisible="{Binding !IsEmpty}" />
                                </Panel>
                            </Button>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Border>

            <!-- Keyboard hints - Muted styling -->
            <TextBlock Text="Arrow keys: Navigate | Enter: Select | PageUp/Down: Switch Box"
                       Foreground="{DynamicResource ThemeTextMutedBrush}"
                       FontSize="11"
                       HorizontalAlignment="Center" />
        </StackPanel>
    </Border>
</UserControl>
