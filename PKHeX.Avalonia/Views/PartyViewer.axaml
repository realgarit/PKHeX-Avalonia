<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:PKHeX.Avalonia.ViewModels"
             xmlns:models="using:PKHeX.Avalonia.Models"
             x:Class="PKHeX.Avalonia.Views.PartyViewer"
             x:DataType="vm:PartyViewerViewModel"
             Focusable="True">

    <UserControl.KeyBindings>
        <KeyBinding Gesture="Up" Command="{Binding MoveSelectionCommand}" CommandParameter="Up" />
        <KeyBinding Gesture="Down" Command="{Binding MoveSelectionCommand}" CommandParameter="Down" />
        <KeyBinding Gesture="Enter" Command="{Binding ActivateSlotCommand}" />
        <KeyBinding Gesture="Space" Command="{Binding ActivateSlotCommand}" />
    </UserControl.KeyBindings>

    <Border Padding="16">
        <StackPanel Spacing="8">
            <TextBlock Text="Party" FontWeight="SemiBold" FontSize="16" />
            
            <!-- Party slots (vertical list) -->
            <ItemsControl ItemsSource="{Binding Slots}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="models:PartySlotData">
                        <Button PointerPressed="OnSlotPointerPressed"
                                PointerMoved="OnSlotPointerMoved"
                                DragDrop.AllowDrop="True"
                                DragDrop.Drop="OnSlotDrop"
                                ToolTip.Tip="{Binding ToolTipSummary}"
                                Click="OnSlotClicked" 
                                DoubleTapped="OnSlotDoubleTapped"
                                Tag="{Binding}"
                                Background="Transparent"
                                Padding="8"
                                Margin="0,2"
                                BorderThickness="2"
                                HorizontalContentAlignment="Stretch"
                                Classes.selected="{Binding IsSelected}">
                            <Button.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Header="View (Ctrl+Click)"
                                              Command="{Binding $parent[UserControl].((vm:PartyViewerViewModel)DataContext).ViewSlotCommand}"
                                              CommandParameter="{Binding}"
                                              IsEnabled="{Binding !IsEmpty}" />
                                    <MenuItem Header="Set (Shift+Click)"
                                              Command="{Binding $parent[UserControl].((vm:PartyViewerViewModel)DataContext).SetSlotCommand}"
                                              CommandParameter="{Binding}" />
                                    <Separator />
                                    <MenuItem Header="Delete (Alt+Click)"
                                              Command="{Binding $parent[UserControl].((vm:PartyViewerViewModel)DataContext).DeleteSlotCommand}"
                                              CommandParameter="{Binding}"
                                              IsEnabled="{Binding !IsEmpty}" />
                                </ContextMenu>
                            </Button.ContextMenu>
                            <Button.Styles>
                                <Style Selector="Button">
                                    <Setter Property="BorderBrush" Value="{DynamicResource SystemControlForegroundBaseMediumLowBrush}" />
                                </Style>
                                <Style Selector="Button.selected">
                                    <Setter Property="BorderBrush" Value="{DynamicResource SystemAccentColor}" />
                                    <Setter Property="Background" Value="{DynamicResource SystemAccentColorLight3}" />
                                </Style>
                            </Button.Styles>
                            
                            <Grid ColumnDefinitions="Auto,*,Auto">
                                <!-- Sprite -->
                                <Image Grid.Column="0" 
                                       Source="{Binding Sprite}" 
                                       Width="68" Height="56"
                                       IsVisible="{Binding !IsEmpty}" />
                                
                                <Border Grid.Column="0"
                                        Width="68" Height="56"
                                        Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                                        CornerRadius="4"
                                        IsVisible="{Binding IsEmpty}" />
                                
                                <!-- Info -->
                                <StackPanel Grid.Column="1" 
                                            VerticalAlignment="Center" 
                                            Margin="12,0,0,0"
                                            IsVisible="{Binding !IsEmpty}">
                                    <TextBlock Text="{Binding Nickname}" FontWeight="SemiBold" />
                                    <TextBlock Text="{Binding SpeciesName}" Opacity="0.7" FontSize="12" />
                                </StackPanel>
                                
                                <TextBlock Grid.Column="1"
                                           Text="Empty"
                                           VerticalAlignment="Center"
                                           Margin="12,0,0,0"
                                           Opacity="0.5"
                                           IsVisible="{Binding IsEmpty}" />
                                
                                <!-- Level and shiny indicator -->
                                <StackPanel Grid.Column="2" 
                                            VerticalAlignment="Center"
                                            IsVisible="{Binding !IsEmpty}">
                                    <TextBlock Text="{Binding Level, StringFormat='Lv. {0}'}" 
                                               HorizontalAlignment="Right" />
                                    <TextBlock Text="â˜…" 
                                               Foreground="Gold" 
                                               FontSize="16"
                                               HorizontalAlignment="Right"
                                               IsVisible="{Binding IsShiny}" />
                                </StackPanel>
                            </Grid>
                        </Button>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
            
            <TextBlock Text="Arrow keys: Navigate | Enter: Edit"
                       Opacity="0.5" FontSize="11" HorizontalAlignment="Center" Margin="0,8,0,0" />
        </StackPanel>
    </Border>
</UserControl>
