<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:PKHeX.Avalonia.ViewModels"
             xmlns:models="using:PKHeX.Avalonia.Models"
             x:Class="PKHeX.Avalonia.Views.PartyViewer"
             x:DataType="vm:PartyViewerViewModel"
             Focusable="True">

    <UserControl.KeyBindings>
        <KeyBinding Gesture="Up" Command="{Binding MoveSelectionCommand}" CommandParameter="Up" />
        <KeyBinding Gesture="Down" Command="{Binding MoveSelectionCommand}" CommandParameter="Down" />
        <KeyBinding Gesture="Enter" Command="{Binding ActivateSlotCommand}" />
        <KeyBinding Gesture="Space" Command="{Binding ActivateSlotCommand}" />
    </UserControl.KeyBindings>

    <Border Padding="16">
        <StackPanel Spacing="8">
            <TextBlock Text="Party" FontWeight="SemiBold" FontSize="16" />
            
            <!-- Party slots (2 columns x 3 rows) -->
            <ItemsControl ItemsSource="{Binding Slots}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <UniformGrid Columns="2" Rows="3" />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="models:PartySlotData">
                        <Button PointerPressed="OnSlotPointerPressed"
                                PointerMoved="OnSlotPointerMoved"
                                DragDrop.AllowDrop="True"
                                DragDrop.Drop="OnSlotDrop"
                                ToolTip.Tip="{Binding ToolTipSummary}"
                                Click="OnSlotClicked" 
                                DoubleTapped="OnSlotDoubleTapped"
                                Tag="{Binding}"
                                Background="Transparent"
                                Padding="4"
                                Margin="2"
                                BorderThickness="1"
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Stretch"
                                HorizontalContentAlignment="Left"
                                Classes.selected="{Binding IsSelected}">
                            <!-- Context Menu -->
                            <Button.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Header="View (Ctrl+Click)"
                                              Command="{Binding $parent[UserControl].((vm:PartyViewerViewModel)DataContext).ViewSlotCommand}"
                                              CommandParameter="{Binding}"
                                              IsEnabled="{Binding !IsEmpty}" />
                                    <MenuItem Header="Set (Shift+Click)"
                                              Command="{Binding $parent[UserControl].((vm:PartyViewerViewModel)DataContext).SetSlotCommand}"
                                              CommandParameter="{Binding}" />
                                    <Separator />
                                    <MenuItem Header="Delete (Alt+Click)"
                                              Command="{Binding $parent[UserControl].((vm:PartyViewerViewModel)DataContext).DeleteSlotCommand}"
                                              CommandParameter="{Binding}"
                                              IsEnabled="{Binding !IsEmpty}" />
                                </ContextMenu>
                            </Button.ContextMenu>
                            
                            <Button.Styles>
                                <Style Selector="Button">
                                    <Setter Property="BorderBrush" Value="{DynamicResource ThemeBorderDefaultBrush}" />
                                    <Setter Property="CornerRadius" Value="6" />
                                </Style>
                                <Style Selector="Button.selected">
                                    <Setter Property="BorderBrush" Value="{DynamicResource ThemeAccentPrimaryBrush}" />
                                    <Setter Property="Background" Value="{DynamicResource ThemeAccentGlowBrush}" />
                                </Style>
                            </Button.Styles>
                            
                            <!-- Compact Card Content -->
                            <Grid ColumnDefinitions="Auto,*">
                                <!-- Sprite -->
                                <Panel Grid.Column="0" Width="60" Height="50">
                                    <Image Source="{Binding Sprite}" IsVisible="{Binding !IsEmpty}" />
                                    <Border Background="{DynamicResource ThemeBackgroundElevatedBrush}"
                                            CornerRadius="4" IsVisible="{Binding IsEmpty}" />
                                    <!-- Illegal Warning -->
                                    <Path Data="M 8,0 L 16,14 L 0,14 Z M 8.5,12 H 7.5 V 10.5 H 8.5 V 12 Z M 8.5,9 H 7.5 V 4.5 H 8.5 V 9 Z" 
                                          Fill="#E3350D" 
                                          HorizontalAlignment="Right" 
                                          VerticalAlignment="Top"
                                          IsVisible="{Binding !IsLegal}"
                                          Width="12" Height="10"/>
                                </Panel>
                                
                                <!-- Info -->
                                <StackPanel Grid.Column="1" Margin="8,0,0,0" VerticalAlignment="Center">
                                    <!-- Name -->
                                    <TextBlock Text="{Binding Nickname}" FontWeight="SemiBold" FontSize="13"
                                               IsVisible="{Binding !IsEmpty}" TextTrimming="CharacterEllipsis"/>
                                    <TextBlock Text="Empty" Opacity="0.5" IsVisible="{Binding IsEmpty}" />
                                    
                                    <!-- Details row -->
                                    <StackPanel Orientation="Horizontal" Spacing="4" IsVisible="{Binding !IsEmpty}">
                                        <TextBlock Text="{Binding Level, StringFormat='Lv.{0}'}" Opacity="0.7" FontSize="11" />
                                        <TextBlock Text="{Binding SpeciesName}" Opacity="0.5" FontSize="11" TextTrimming="CharacterEllipsis" MaxWidth="70" />
                                    </StackPanel>
                                </StackPanel>
                            </Grid>
                        </Button>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
            
            <TextBlock Text="Arrow keys: Navigate | Enter: Edit"
                       Opacity="0.5" FontSize="11" HorizontalAlignment="Center" Margin="0,8,0,0" />
        </StackPanel>
    </Border>
</UserControl>
