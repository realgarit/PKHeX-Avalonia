<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:PKHeX.Avalonia.ViewModels"
             xmlns:models="using:PKHeX.Avalonia.Models"
             x:Class="PKHeX.Avalonia.Views.PartyViewer"
             x:DataType="vm:PartyViewerViewModel"
             Focusable="True">

    <UserControl.KeyBindings>
        <KeyBinding Gesture="Up" Command="{Binding MoveSelectionCommand}" CommandParameter="Up" />
        <KeyBinding Gesture="Down" Command="{Binding MoveSelectionCommand}" CommandParameter="Down" />
        <KeyBinding Gesture="Enter" Command="{Binding ActivateSlotCommand}" />
        <KeyBinding Gesture="Space" Command="{Binding ActivateSlotCommand}" />
    </UserControl.KeyBindings>

    <Border Padding="16" Classes="view-container">
        <DockPanel>
            <!-- Header -->
            <TextBlock DockPanel.Dock="Top" Text="Party" FontWeight="SemiBold" FontSize="18" Margin="0,0,0,12" />
            
            <!-- Footer -->
            <TextBlock DockPanel.Dock="Bottom" 
                       Text="↑↓ Navigate | Enter: Edit | Drag to reorder"
                       Opacity="0.5" FontSize="11" HorizontalAlignment="Center" Margin="0,12,0,0" />
            
            <!-- Party Grid - 2 columns, 3 rows -->
            <Border Classes="section-card" Padding="8">
                <ItemsControl ItemsSource="{Binding Slots}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <UniformGrid Columns="2" Rows="3" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="models:PartySlotData">
                            <Button PointerPressed="OnSlotPointerPressed"
                                    PointerMoved="OnSlotPointerMoved"
                                    DragDrop.AllowDrop="True"
                                    DragDrop.Drop="OnSlotDrop"
                                    ToolTip.Tip="{Binding ToolTipSummary}"
                                    Click="OnSlotClicked" 
                                    DoubleTapped="OnSlotDoubleTapped"
                                    Tag="{Binding}"
                                    Padding="8"
                                    Margin="4"
                                    HorizontalAlignment="Stretch"
                                    VerticalAlignment="Stretch"
                                    HorizontalContentAlignment="Stretch"
                                    Classes.selected="{Binding IsSelected}">
                                
                                <!-- Context Menu -->
                                <Button.ContextMenu>
                                    <ContextMenu>
                                        <MenuItem Header="View (Ctrl+Click)"
                                                  Command="{Binding $parent[UserControl].((vm:PartyViewerViewModel)DataContext).ViewSlotCommand}"
                                                  CommandParameter="{Binding}"
                                                  IsEnabled="{Binding !IsEmpty}" />
                                        <MenuItem Header="Set (Shift+Click)"
                                                  Command="{Binding $parent[UserControl].((vm:PartyViewerViewModel)DataContext).SetSlotCommand}"
                                                  CommandParameter="{Binding}" />
                                        <Separator />
                                        <MenuItem Header="Delete (Alt+Click)"
                                                  Command="{Binding $parent[UserControl].((vm:PartyViewerViewModel)DataContext).DeleteSlotCommand}"
                                                  CommandParameter="{Binding}"
                                                  IsEnabled="{Binding !IsEmpty}" />
                                    </ContextMenu>
                                </Button.ContextMenu>
                                
                                <Button.Styles>
                                    <Style Selector="Button">
                                        <Setter Property="Background" Value="{DynamicResource ThemeBackgroundElevatedBrush}" />
                                        <Setter Property="BorderBrush" Value="{DynamicResource ThemeBorderDefaultBrush}" />
                                        <Setter Property="BorderThickness" Value="1" />
                                        <Setter Property="CornerRadius" Value="8" />
                                    </Style>
                                    <Style Selector="Button:pointerover">
                                        <Setter Property="BorderBrush" Value="{DynamicResource ThemeAccentPrimaryBrush}" />
                                    </Style>
                                    <Style Selector="Button.selected">
                                        <Setter Property="BorderBrush" Value="{DynamicResource ThemeAccentPrimaryBrush}" />
                                        <Setter Property="BorderThickness" Value="2" />
                                    </Style>
                                </Button.Styles>
                                
                                <!-- Card Content - Sprite centered with overlay info -->
                                <Panel>
                                    <!-- Empty slot -->
                                    <Border Background="{DynamicResource ThemeBackgroundCardBrush}"
                                            CornerRadius="4" 
                                            IsVisible="{Binding IsEmpty}"
                                            Height="70">
                                        <TextBlock Text="Empty" 
                                                   Opacity="0.4" 
                                                   HorizontalAlignment="Center" 
                                                   VerticalAlignment="Center" />
                                    </Border>
                                    
                                    <!-- Filled slot -->
                                    <Grid RowDefinitions="*,Auto" IsVisible="{Binding !IsEmpty}">
                                        <!-- Sprite with warning indicator -->
                                        <Panel Grid.Row="0" HorizontalAlignment="Center">
                                            <Image Source="{Binding Sprite}" 
                                                   Width="56" Height="48" 
                                                   RenderOptions.BitmapInterpolationMode="HighQuality" />
                                            
                                            <!-- Illegal Warning -->
                                            <Path Data="M 8,0 L 16,14 L 0,14 Z M 8.5,12 H 7.5 V 10.5 H 8.5 V 12 Z M 8.5,9 H 7.5 V 4.5 H 8.5 V 9 Z" 
                                                  Fill="#E3350D" 
                                                  HorizontalAlignment="Right" 
                                                  VerticalAlignment="Top"
                                                  IsVisible="{Binding !IsLegal}"
                                                  Margin="0,0,0,0"
                                                  Width="10" Height="9"/>
                                        </Panel>
                                        
                                        <!-- Info: Nickname only, with level badge -->
                                        <DockPanel Grid.Row="1" Margin="0,4,0,0">
                                            <Border DockPanel.Dock="Right" 
                                                    Background="{DynamicResource ThemeBackgroundCardBrush}" 
                                                    CornerRadius="3" 
                                                    Padding="4,1">
                                                <TextBlock Text="{Binding Level, StringFormat='Lv.{0}'}" 
                                                           FontSize="10" 
                                                           Opacity="0.8" />
                                            </Border>
                                            <TextBlock Text="{Binding Nickname}" 
                                                       FontWeight="SemiBold" 
                                                       FontSize="12"
                                                       TextTrimming="CharacterEllipsis"
                                                       VerticalAlignment="Center" />
                                        </DockPanel>
                                    </Grid>
                                </Panel>
                            </Button>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Border>
        </DockPanel>
    </Border>
</UserControl>
